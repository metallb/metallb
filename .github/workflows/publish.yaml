name: Publish
on:
  push:
    branches:
      - 'main'
      - 'v.*'
    tags:
      - '.*'

jobs:
  publish:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        creds:
          - username: DOCKER_USER
            password: DOCKER_PASSWORD
            registry: docker.io
          - username: QUAY_USER
            password: QUAY_PASSWORD
            registry: quay.io
    env:
      DOCKER_BUILD_CMD: "docker buildx build --load"
      REGISTRY_USER: ${{ secrets[format('{0}', matrix.creds.username)] }}
      REGISTRY_PASSWORD: ${{ secrets[format('{0}', matrix.creds.password)] }}
      REGISTRY: ${{ matrix.creds.registry }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3-pip arping ndisc6
          sudo pip3 install invoke semver pyyaml

      - uses: actions/setup-go@v2
        with:
          go-version: '1.16'

      - name: Run Unit Tests
        run: |
          inv test
          cp manifests/metallb.yaml manifests/metallb.yaml.prev

      - name: Run Linter
        run: |
          inv checkpatch
          inv lint -e host
          inv verifylicense

      - name: Docker Login
        run: docker login $REGISTRY -u $REGISTRY_USER -p $REGISTRY_PASSWORD
        
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Download Manifest Tool
        run: |
          mkdir -p ./bin
          wget -O ./bin/manifest-tool https://github.com/estesp/manifest-tool/releases/download/v1.0.3/manifest-tool-linux-amd64 && chmod +x ./bin/manifest-tool

      - name: Build and Push
        run: PATH=./bin:$PATH inv push-multiarch --binaries=controller --binaries=speaker --registry=$REGISTRY --repo=metallb --tag=${GITHUB_REF_NAME}
